{
	"name": "bike_share query",
	"properties": {
		"content": {
			"query": "-- CREATE TABLE dbo.bikeshare_raw (\n--     Duration INT,\n--     StartDate DATETIME2,\n--     EndDate DATETIME2,\n--     StartStationNumber INT,\n--     StartStation NVARCHAR(255),\n--     EndStationNumber INT,\n--     EndStation NVARCHAR(255),\n--     BikeNumber NVARCHAR(50),\n--     MemberType NVARCHAR(50)\n--     ) \n--     WITH (\n--         DISTRIBUTION = HASH(StartStationNumber),\n--         CLUSTERED COLUMNSTORE INDEX\n-- );\n\n-- SET SHOWPLAN_XML ON;\n\n-- EXPLAIN\nEXPLAIN WITH_RECOMMENDATIONS\nSELECT \n    StartStationNumber,\n    MONTH(StartDate) AS StartMonth,\n    YEAR(StartDate) AS StartYear,\n    COUNT(*) AS movement,\n    AVG(Duration) AS AverageDuration,\n    SUM(Duration) AS TotalDuration\nFROM dbo.bikeshare_raw\nGROUP BY StartStationNumber, MONTH(StartDate), Year(StartDate)\nORDER BY 1, 3, 2\n\n\nCREATE MATERIALIZED VIEW View1 WITH (DISTRIBUTION = HASH([Expr0])) AS \nSELECT \n    [az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartStationNumber] AS [Expr0], \n    datepart(month,[az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartDate]) AS [Expr1], \n    datepart(year,[az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartDate]) AS [Expr2], \n    COUNT(*) AS [Expr3], \n    AVG([az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[Duration]) AS [Expr4], \n    SUM([az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[Duration]) AS [Expr5], \n    COUNT_BIG([az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[Duration]) AS [Expr8] \nFROM [dbo].[bikeshare_raw] \nGROUP BY [az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartStationNumber], \n    datepart(month,[az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartDate]), \n    datepart(year,[az_dedicated_sql_pool_for_milgard_practice].[dbo].[bikeshare_raw].[StartDate])\n\nSELECT * FROM sys.dm_pdw_exec_requests\nORDER BY submit_time DESC\n\nSHOW_STATISTICS dbo.bikeshare_raw;\n\nUPDATE STATISTICS dbo.bikeshare_raw WITH FULLSCAN;\n\n\nWITH request_steps AS(\nSELECT request_id, command, total_elapsed_time, operation_type, step_index\nFROM sys.dm_pdw_request_steps\nWHERE request_id IN ('QID595')\n-- ORDER BY request_id, step_index\n)\nSELECT \n    distribution_id, dpsr.total_elapsed_time\n    -- rs.operation_type, rs.total_elapsed_time, dpsr.*\nFROM sys.dm_pdw_sql_requests dpsr\nJOIN request_steps rs\n    ON dpsr.request_id = rs.request_id AND dpsr.step_index = rs.step_index AND rs.total_elapsed_time>150 AND operation_type = 'ShuffleMoveOperation'\nORDER BY rs.step_index\n\n\nDBCC PDW_SHOWSPACEUSED(\"dbo.bikeshare_raw\")\n\n\n-- Create all three tables first\nCREATE TABLE dbo.highUnemployement(\n    State NVARCHAR(2),\n    Year INT,\n    average_unemployment_rate FLOAT,\n    sum_unemployed INT\n) WITH(\n    DISTRIBUTION = HASH(State),\n    CLUSTERED COLUMNSTORE INDEX\n);\n\nCREATE TABLE dbo.mediumUnemployement(\n    State NVARCHAR(2),\n    Year INT,\n    average_unemployment_rate FLOAT,\n    sum_unemployed INT\n) WITH(\n    DISTRIBUTION = HASH(State),\n    CLUSTERED COLUMNSTORE INDEX\n);\n\nCREATE TABLE dbo.lowUnemployement(\n    State NVARCHAR(2),\n    Year INT,\n    average_unemployment_rate FLOAT,\n    sum_unemployed INT\n) WITH(\n    DISTRIBUTION = HASH(State),\n    CLUSTERED COLUMNSTORE INDEX\n);\n\n\n\n-- Grant bulk operations permission to the service principal\nGRANT ADMINISTER DATABASE BULK OPERATIONS TO [synapse-dataflow-sp];\n\n-- Also ensure it has ALTER permission on the schema\nGRANT ALTER ON SCHEMA::dbo TO [synapse-dataflow-sp];\n\n-- Grant CONTROL on the specific tables for full access\nGRANT CONTROL ON dbo.highUnemployement TO [synapse-dataflow-sp];\nGRANT CONTROL ON dbo.mediumUnemployement TO [synapse-dataflow-sp];\nGRANT CONTROL ON dbo.lowUnemployement TO [synapse-dataflow-sp];\n\n-- Check all permissions for the service principal\nSELECT \n    *,\n    p.state_desc,\n    p.permission_name,\n    p.class_desc,\n    p.major_id,\n    o.name as object_name\nFROM sys.database_permissions p\nLEFT JOIN sys.objects o ON p.major_id = o.object_id\n-- WHERE grantee_principal_id = USER_ID('synapse-dataflow-sp')\nORDER BY p.permission_name;\n\n\n-- GO\n-- WITH qids AS (\n-- SELECT\n--     request_id,\n--     status,\n--     submit_time,\n--     total_elapsed_time,\n--     command\n-- FROM\n--     sys.dm_pdw_exec_requests\n-- WHERE\n--     session_id = SESSION_ID() -- Gets only queries from your current window\n-- )\n\n-- SELECT \n--     request_id,\n--     command\n-- FROM sys.dm_pdw_sql_requests\n-- SELECT\n--     step_index,\n--     operation_type,\n--     total_elapsed_time,\n--     row_count,\n--     command\n-- FROM\n--     sys.dm_pdw_request_steps\n-- WHERE request_id in (SELECT request_id FROM qids)\n-- ORDER BY\n--     total_elapsed_time DESC; -- Sort by the longest step first\n\n\n-- In your dedicated SQL pool\nCREATE USER [synapse-dataflow-sp] FROM EXTERNAL PROVIDER;\n\nEXEC sp_addrolemember 'db_datareader', 'synapse-dataflow-sp';\nEXEC sp_addrolemember 'db_datawriter', 'synapse-dataflow-sp';\nEXEC sp_addrolemember 'db_ddladmin', 'synapse-dataflow-sp';\n\n\nSELECT * FROM sys.database_principals \nWHERE name = 'synapse-dataflow-sp';\n\nSELECT \n    p.name AS principal_name,\n    r.name AS role_name\nFROM sys.database_principals p\nJOIN sys.database_role_members rm ON p.principal_id = rm.member_principal_id\nJOIN sys.database_principals r ON rm.role_principal_id = r.principal_id\nWHERE p.name = 'synapse-dataflow-sp';\n\n\n\n\n\nSELECT * FROM highUnemployment",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "az_dedicated_sql_pool_for_milgard_practice",
				"poolName": "az_dedicated_sql_pool_for_milgard_practice"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}